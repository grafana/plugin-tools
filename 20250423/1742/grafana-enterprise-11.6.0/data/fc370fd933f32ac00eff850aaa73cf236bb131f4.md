# Test info

- Name: should be possible to load and execute an existing valid query
- Location: /home/runner/work/plugin-tools/plugin-tools/packages/plugin-e2e/tests/as-admin-user/datasource/query-editor/queryEditor.integration.spec.ts:27:5

# Error details

```
Error: Expected: Response status code is within 200..299 range.
Received: Error: locator.click: Test timeout of 30000ms exceeded.
Call log:
  - waiting for locator('[data-testid="data-testid toggle-viz-options"]')

    at /home/runner/work/plugin-tools/plugin-tools/packages/plugin-e2e/tests/as-admin-user/datasource/query-editor/queryEditor.integration.spec.ts:33:46
```

# Page snapshot

```yaml
- link "Skip to main content":
  - /url: "#pageContent"
- button "Close menu":
  - img "Grafana"
- text: Grafana
- button "Undock menu"
- navigation:
  - list "Navigation":
    - listitem:
      - link "Home":
        - /url: /
    - listitem:
      - link "Bookmarks":
        - /url: /bookmarks
      - button "Expand section Bookmarks"
    - listitem:
      - link "Starred":
        - /url: /dashboards?starred
      - button "Expand section Starred"
    - listitem:
      - link "Dashboards":
        - /url: /dashboards
      - button "Expand section Dashboards"
    - listitem:
      - link "Explore":
        - /url: /explore
    - listitem:
      - link "Drilldown New!":
        - /url: /drilldown
      - button "Expand section Drilldown"
    - listitem:
      - link "Alerting":
        - /url: /alerting
      - button "Expand section Alerting"
    - listitem:
      - link "Connections":
        - /url: /connections
      - button "Expand section Connections"
    - listitem:
      - link "More apps":
        - /url: /apps
      - button "Expand section More apps"
    - listitem:
      - link "Administration":
        - /url: /admin
      - button "Expand section Administration"
- banner:
  - navigation "Breadcrumbs":
    - list:
      - listitem:
        - link "Home":
          - /url: /
      - listitem:
        - link "Dashboards":
          - /url: /dashboards
      - listitem:
        - link "E2E dashboards":
          - /url: /dashboards/f/fejroo1v22gw0c/e2e-dashboards
      - listitem:
        - link "Test datasource dashboard":
          - /url: /d/be6sir7o1iccgb/test-datasource-dashboard?orgId=1&from=now-1h&to=now&timezone=browser&var-var1=A
      - listitem: Edit panel
  - button "Search or jump to..."
  - text: ctrl+k
  - button "New"
  - button "Help"
  - button "Enable kiosk mode"
  - button "Profile":
    - img "User avatar"
  - button "Back to dashboard"
  - button "Discard panel changes" [disabled]
  - button "Save dashboard"
  - button "More save options"
- main:
  - text: var1
  - log
  - text: A
  - combobox
  - text: Table view
  - switch "toggle-table-view"
  - 'button "Time range selected: Last 1 hour"': Last 1 hour
  - button "Zoom out time range"
  - button "Refresh"
  - button "Auto refresh turned off. Choose refresh time interval"
  - region "Panel Title":
    - heading "Panel Title" [level=2]
    - list:
      - listitem:
        - button "values"
  - separator "Pane resize widget"
  - tablist:
    - tab "Queries1" [selected]
    - tab "Transformations0"
    - tab "Alert0"
  - text: Data source
  - img "Test-Datasource logo"
  - textbox "Select a data source"
  - button "Open data source help"
  - button "Expand query row"
  - text: Query options MD = auto = 1266 Interval = 2s
  - button "Query inspector button": Query inspector
  - button "Collapse query row" [expanded]
  - button "Query editor row title A": A
  - emphasis: (test-datasource)
  - button "Duplicate query"
  - button "Hide response"
  - button "Remove query"
  - button "Drag and drop to reorder":
    - img "Drag and drop to reorder"
  - text: Constant
  - spinbutton "Constant": "6.5"
  - text: Projects
  - log
  - text: project-1
  - combobox "Projects"
  - text: Query Text
  - img
  - textbox "Query Text": test
  - button "Add query"
  - button "Expression"
  - separator "Pane resize widget"
  - button "Change Visualization": Time series
  - textbox "Search options"
  - radiogroup:
    - radio "All" [checked]
    - text: All
    - radio "Overrides"
    - text: Overrides
  - heading "Panel options" [level=6]
  - button [expanded]
  - text: Title
  - textbox: Panel Title
  - text: Description
  - textbox
  - text: Transparent background
  - switch
  - heading "Panel links" [level=6]
  - button
  - heading "Repeat options" [level=6]
  - button
  - heading "Tooltip" [level=6]
  - button [expanded]
  - text: Tooltip mode
  - radiogroup:
    - radio "Single" [checked]
    - text: Single
    - radio "All"
    - text: All
    - radio "Hidden"
    - text: Hidden
  - text: Hover proximity How close the cursor must be to a point to trigger the tooltip, in pixels
  - spinbutton
  - text: Max width
  - spinbutton
  - heading "Legend" [level=6]
  - button [expanded]
  - text: Visibility
  - switch [checked]
  - text: Mode
  - radiogroup:
    - radio "List" [checked]
    - text: List
    - radio "Table"
    - text: Table
  - text: Placement
  - radiogroup:
    - radio "Bottom" [checked]
    - text: Bottom
    - radio "Right"
    - text: Right
  - text: Values Select values or calculations to show in legend
  - log
  - text: Choose
  - combobox
  - heading "Axis" [level=6]
  - button [expanded]
  - text: Time zone
  - list:
    - listitem:
      - log
      - text: Default
      - combobox "Time zone picker"
      - button "Add timezone"
  - text: Placement
  - radiogroup:
    - radio "Auto" [checked]
    - text: Auto
    - radio "Left"
    - text: Left
    - radio "Right"
    - text: Right
    - radio "Hidden"
    - text: Hidden
  - text: Label
  - textbox "Optional text"
  - text: Width
  - spinbutton
  - text: Show grid lines
  - radiogroup:
    - radio "Auto" [checked]
    - text: Auto
    - radio "On"
    - text: "On"
    - radio "Off"
    - text: "Off"
  - text: Color
  - radiogroup:
    - radio "Text" [checked]
    - text: Text
    - radio "Series"
    - text: Series
  - text: Show border
  - switch
  - text: Scale
  - radiogroup:
    - radio "Linear" [checked]
    - text: Linear
    - radio "Logarithmic"
    - text: Logarithmic
    - radio "Symlog"
    - text: Symlog
  - text: Centered zero
  - switch
  - text: Soft min
  - spinbutton
  - text: Soft max
  - spinbutton
  - heading "Graph styles" [level=6]
  - button [expanded]
  - text: Style
  - radiogroup:
    - radio "Lines" [checked]
    - text: Lines
    - radio "Bars"
    - text: Bars
    - radio "Points"
    - text: Points
  - text: Line interpolation
  - radiogroup:
    - radio [checked]
    - radio
    - radio
    - radio
  - text: Line width
  - slider "Line width"
  - text: 0 10
  - spinbutton: "1"
  - text: Fill opacity
  - slider "Fill opacity"
  - text: 0 100
  - spinbutton: "0"
  - text: Gradient mode
  - radiogroup:
    - radio "None" [checked]
    - text: None
    - radio "Opacity"
    - text: Opacity
    - radio "Hue"
    - text: Hue
    - radio "Scheme"
    - text: Scheme
  - text: Line style
  - radiogroup:
    - radio "Solid" [checked]
    - text: Solid
    - radio "Dash"
    - text: Dash
    - radio "Dots"
    - text: Dots
  - text: Connect null values
  - radiogroup:
    - radio "Never" [checked]
    - text: Never
    - radio "Always"
    - text: Always
    - radio "Threshold"
    - text: Threshold
  - text: Disconnect values
  - radiogroup:
    - radio "Never" [checked]
    - text: Never
    - radio "Threshold"
    - text: Threshold
  - text: Show points
  - radiogroup:
    - radio "Auto" [checked]
    - text: Auto
    - radio "Always"
    - text: Always
    - radio "Never"
    - text: Never
  - text: Point size
  - slider "Point size"
  - text: 1 40
  - spinbutton: "5"
  - text: Stack series
  - radiogroup:
    - radio "Off" [checked]
    - text: "Off"
    - radio "Normal"
    - text: Normal
    - radio "100%"
    - text: 100%
  - heading "Standard options" [level=6]
  - button [expanded]
  - text: Unit
  - textbox "Choose"
  - text: Min Leave empty to calculate based on all values
  - spinbutton
  - text: Max Leave empty to calculate based on all values
  - spinbutton
  - text: Field min/max Calculate min max per field
  - switch
  - text: Decimals
  - spinbutton
  - text: Display name Change the field or series name
  - textbox "none"
  - text: Color scheme
  - log
  - text: Classic palette
  - combobox
  - text: No value What to show when there is no value
  - textbox "-"
  - heading "Data links and actions" [level=6]
  - button [expanded]
  - text: Data links
  - button "Add link"
  - text: Actions
  - button "Add action"
  - heading "Value mappings" [level=6]
  - button [expanded]
  - table:
    - rowgroup
  - button "Add value mappings"
  - heading "Thresholds" [level=6]
  - button [expanded]
  - button "Add threshold"
  - button "red color"
  - spinbutton "Threshold 1": "80"
  - button "Remove Threshold 1"
  - button "green color"
  - textbox "Threshold 2" [disabled]: Base
  - text: Thresholds mode Percentage means thresholds relative to min & max
  - radiogroup:
    - radio "Absolute" [checked]
    - text: Absolute
    - radio "Percentage"
    - text: Percentage
  - text: Show thresholds
  - log
  - text: "Off"
  - combobox
  - button "Add field override"
```

# Test source

```ts
   1 | import { expect, test } from '../../../../src';
   2 |
   3 | test('should return data and not display panel error when a valid query is provided', async ({
   4 |   panelEditPage,
   5 |   readProvisionedDataSource,
   6 | }) => {
   7 |   const ds = await readProvisionedDataSource({ fileName: 'testdatasource.yaml' });
   8 |   await panelEditPage.datasource.set(ds.name);
   9 |   const editorRow = await panelEditPage.getQueryEditorRow('A');
  10 |   await editorRow.getByRole('textbox', { name: 'Query Text' }).fill('query');
  11 |   await expect(panelEditPage.refreshPanel()).toBeOK();
  12 |   await expect(panelEditPage.panel.getErrorIcon()).not.toBeVisible();
  13 | });
  14 |
  15 | test('should return an error and display panel error when query is invalid', async ({
  16 |   panelEditPage,
  17 |   readProvisionedDataSource,
  18 | }) => {
  19 |   const ds = await readProvisionedDataSource({ fileName: 'testdatasource.yaml' });
  20 |   await panelEditPage.datasource.set(ds.name);
  21 |   const editorRow = await panelEditPage.getQueryEditorRow('A');
  22 |   await editorRow.getByRole('textbox', { name: 'Query Text' }).fill('error');
  23 |   await expect(panelEditPage.refreshPanel()).not.toBeOK();
  24 |   await expect(panelEditPage.panel.getErrorIcon()).toBeVisible();
  25 | });
  26 |
  27 | test('should be possible to load and execute an existing valid query', async ({
  28 |   gotoPanelEditPage,
  29 |   readProvisionedDashboard,
  30 | }) => {
  31 |   const dashboard = await readProvisionedDashboard({ fileName: 'testdatasource.json' });
  32 |   const panelEditPage = await gotoPanelEditPage({ dashboard, id: '1' });
> 33 |   await expect(panelEditPage.refreshPanel()).toBeOK();
     |                                              ^ Error: Expected: Response status code is within 200..299 range.
  34 |   await expect(panelEditPage.panel.getErrorIcon()).not.toBeVisible();
  35 | });
  36 |
  37 | // DEBUG=pw:browser
  38 |
```

# Local changes

```diff
diff --git a/package-lock.json b/package-lock.json
index e3a2d82d..8e2cdc48 100644
--- a/package-lock.json
+++ b/package-lock.json
@@ -23,6 +23,7 @@
         "@auto-it/omit-commits": "11.3.0",
         "@auto-it/slack": "11.3.0",
         "@grafana/eslint-config": "^8.0.0",
+        "@playwright/test": "^1.52.0",
         "@rollup/plugin-commonjs": "^28.0.3",
         "@rollup/plugin-json": "^6.1.0",
         "@rollup/plugin-node-resolve": "^16.0.1",
diff --git a/package.json b/package.json
index 55bf79ab..94a402c9 100644
--- a/package.json
+++ b/package.json
@@ -28,6 +28,7 @@
     "@auto-it/omit-commits": "11.3.0",
     "@auto-it/slack": "11.3.0",
     "@grafana/eslint-config": "^8.0.0",
+    "@playwright/test": "^1.52.0",
     "@rollup/plugin-commonjs": "^28.0.3",
     "@rollup/plugin-json": "^6.1.0",
     "@rollup/plugin-node-resolve": "^16.0.1",
diff --git a/packages/create-plugin/templates/common/playwright.config b/packages/create-plugin/templates/common/playwright.config
index c84567bf..9c8c609f 100644
--- a/packages/create-plugin/templates/common/playwright.config
+++ b/packages/create-plugin/templates/common/playwright.config
@@ -46,10 +46,6 @@ export default defineConfig<PluginOptions>({
       use: {
         ...devices['Desktop Chrome'],
         storageState: 'playwright/.auth/admin.json',
-        launchOptions: {
-          args: ['--disable-features=PlzDedicatedWorker'], // because https://github.com/microsoft/playwright/pull/34400
-        },
-        channel: 'chrome',
       },
       dependencies: ['auth'],
     },
diff --git a/packages/plugin-e2e/playwright.config.ts b/packages/plugin-e2e/playwright.config.ts
index 4621f529..667c7401 100644
--- a/packages/plugin-e2e/playwright.config.ts
+++ b/packages/plugin-e2e/playwright.config.ts
@@ -72,11 +72,7 @@ export default defineConfig<PluginOptions>({
       testDir: './tests/as-admin-user',
       use: {
         ...devices['Desktop Chrome'],
-        launchOptions: {
-          args: ['--disable-features=PlzDedicatedWorker'], // because https://github.com/microsoft/playwright/pull/34400
-        },
         storageState: 'playwright/.auth/admin.json',
-        channel: 'chrome',
       },
       dependencies: ['authenticate'],
     },
@@ -87,15 +83,11 @@ export default defineConfig<PluginOptions>({
       testDir: './tests/as-admin-user',
       use: {
         ...devices['Desktop Chrome'],
-        launchOptions: {
-          args: ['--disable-features=PlzDedicatedWorker'], // because https://github.com/microsoft/playwright/pull/34400
-        },
         storageState: 'playwright/.auth/admin.json',
         viewport: {
           width: 1920,
           height: 1080,
         },
-        channel: 'chrome',
       },
       dependencies: ['authenticate'],
     },
@@ -105,11 +97,7 @@ export default defineConfig<PluginOptions>({
       testDir: './tests/as-viewer-user',
       use: {
         ...devices['Desktop Chrome'],
-        launchOptions: {
-          args: ['--disable-features=PlzDedicatedWorker'], // because https://github.com/microsoft/playwright/pull/34400
-        },
         storageState: 'playwright/.auth/viewer.json',
-        channel: 'chrome',
       },
       dependencies: ['createUserAndAuthenticate'],
     },
diff --git a/packages/plugin-e2e/src/models/components/DataSourcePicker.ts b/packages/plugin-e2e/src/models/components/DataSourcePicker.ts
index 4b0910fd..0df58a42 100644
--- a/packages/plugin-e2e/src/models/components/DataSourcePicker.ts
+++ b/packages/plugin-e2e/src/models/components/DataSourcePicker.ts
@@ -15,12 +15,12 @@ export class DataSourcePicker extends GrafanaPage {
    * Sets the data source picker to the provided name
    */
   async set(name: string) {
-    let datasourcePicker = (this.root || this.ctx.page).getByTestId(
+    let datasourcePicker = await (this.root || this.ctx.page).getByTestId(
       this.ctx.selectors.components.DataSourcePicker.inputV2
     );
 
     if (semver.lt(this.ctx.grafanaVersion, '10.1.0')) {
-      datasourcePicker = this.getByGrafanaSelector(this.ctx.selectors.components.DataSourcePicker.container, {
+      datasourcePicker = await this.getByGrafanaSelector(this.ctx.selectors.components.DataSourcePicker.container, {
         root: this.root,
       }).locator('input');
     }
diff --git a/packages/plugin-e2e/src/models/pages/DashboardPage.ts b/packages/plugin-e2e/src/models/pages/DashboardPage.ts
index 3446d67a..ccb014a1 100644
--- a/packages/plugin-e2e/src/models/pages/DashboardPage.ts
+++ b/packages/plugin-e2e/src/models/pages/DashboardPage.ts
@@ -94,9 +94,10 @@ export class DashboardPage extends GrafanaPage {
       await this.getByGrafanaSelector(components.NavToolbar.editDashboard.editButton).click();
     }
     // on small screens, the toolbar buttons are hidden behind a "Show more items" button
-    const toolbarButtonsHidden = !scenesEnabled && !!(await this.ctx.page.getByLabel('Show more items').count());
+    const showMoreItems = await this.ctx.page.getByLabel('Show more items');
+    const toolbarButtonsHidden = !scenesEnabled && (await showMoreItems.count()) > 0;
     if (toolbarButtonsHidden) {
-      await this.ctx.page.getByLabel('Show more items').click();
+      await showMoreItems.click();
     }
 
     if (semver.gte(this.ctx.grafanaVersion, '9.5.0')) {
diff --git a/packages/plugin-e2e/src/models/pages/GrafanaPage.ts b/packages/plugin-e2e/src/models/pages/GrafanaPage.ts
index 7603e2a2..59ea2e0c 100644
--- a/packages/plugin-e2e/src/models/pages/GrafanaPage.ts
+++ b/packages/plugin-e2e/src/models/pages/GrafanaPage.ts
@@ -19,7 +19,7 @@ export abstract class GrafanaPage {
       url += `?${queryParams.toString()}`;
     }
     await this.ctx.page.goto(url, {
-      waitUntil: 'networkidle',
+      waitUntil: 'load',
       ...this.pageArgs,
       ...options,
     });
diff --git a/packages/plugin-e2e/src/models/pages/VariableEditPage.ts b/packages/plugin-e2e/src/models/pages/VariableEditPage.ts
index f2dba860..10e552f6 100644
--- a/packages/plugin-e2e/src/models/pages/VariableEditPage.ts
+++ b/packages/plugin-e2e/src/models/pages/VariableEditPage.ts
@@ -1,4 +1,5 @@
 import * as semver from 'semver';
+import { expect } from '@playwright/test';
 import { DashboardEditViewArgs, NavigateOptions, PluginTestCtx } from '../../types';
 import { DataSourcePicker } from '../components/DataSourcePicker';
 import { GrafanaPage } from './GrafanaPage';
@@ -30,9 +31,10 @@ export class VariableEditPage extends GrafanaPage {
     // In versions before 9.2.0, the variable index is not part of the URL so there's no way to navigate to it directly.
     // Instead, we have to click the nth row in the variable list to navigate to the edit page for a given variable index.
     if (semver.lt(this.ctx.grafanaVersion, '9.2.0') && this.args.id) {
-      const list = this.getByGrafanaSelector(this.ctx.selectors.pages.Dashboard.Settings.Variables.List.table).locator(
-        'tbody tr'
-      );
+      const list = await this.getByGrafanaSelector(
+        this.ctx.selectors.pages.Dashboard.Settings.Variables.List.table
+      ).locator('tbody tr');
+      await expect(list).toBeVisible();
       const variables = await list.all();
       await variables[Number(this.args.id)].click();
     }
diff --git a/packages/plugin-e2e/tests/as-admin-user/app/app-config/appConfig.spec.ts b/packages/plugin-e2e/tests/as-admin-user/app/app-config/appConfig.spec.ts
index c8c06927..e176a8b8 100644
--- a/packages/plugin-e2e/tests/as-admin-user/app/app-config/appConfig.spec.ts
+++ b/packages/plugin-e2e/tests/as-admin-user/app/app-config/appConfig.spec.ts
@@ -16,6 +16,6 @@ test('should wait for plugin config settings API to respond', async ({ gotoAppCo
   );
 
   const response = configPage.waitForSettingsResponse();
-  await page.getByRole('button', { name: 'Disable' }).first().click();
+  await page.getByRole('button', { name: /Disable|Enable/i }).first().click();
   await expect(response).toBeOK();
 });
diff --git a/packages/plugin-e2e/tests/as-admin-user/datasource/query-editor/queryEditor.integration.spec.ts b/packages/plugin-e2e/tests/as-admin-user/datasource/query-editor/queryEditor.integration.spec.ts
index 51eb8f92..68316e84 100644
--- a/packages/plugin-e2e/tests/as-admin-user/datasource/query-editor/queryEditor.integration.spec.ts
+++ b/packages/plugin-e2e/tests/as-admin-user/datasource/query-editor/queryEditor.integration.spec.ts
@@ -33,3 +33,5 @@ test('should be possible to load and execute an existing valid query', async ({
   await expect(panelEditPage.refreshPanel()).toBeOK();
   await expect(panelEditPage.panel.getErrorIcon()).not.toBeVisible();
 });
+
+// DEBUG=pw:browser
```