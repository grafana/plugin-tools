# Test info

- Name: Test alert rule APIs >> should be possible to disable advanced mode
- Location: /home/runner/work/plugin-tools/plugin-tools/packages/plugin-e2e/tests/as-admin-user/datasource/alerting/alerting.advancedMode.spec.ts:19:7

# Error details

```
Error: Expected: true
Received: Error: Timed out 5000ms waiting for expect(locator).toBeChecked()

Locator: locator('[data-testid="data-testid advanced-mode-switch step-2"]')
Expected: checked
Received: unchecked
Call log:
  - expect.toBeChecked with timeout 5000ms
  - waiting for locator('[data-testid="data-testid advanced-mode-switch step-2"]')
    6 Ã— locator resolved to <input role="switch" id="switch-1" type="checkbox" data-testid="data-testid advanced-mode-switch step-2"/>
      - unexpected value "unchecked"

    at /home/runner/work/plugin-tools/plugin-tools/packages/plugin-e2e/tests/as-admin-user/datasource/alerting/alerting.advancedMode.spec.ts:22:56
```

# Page snapshot

```yaml
- link "Skip to main content":
  - /url: "#pageContent"
- banner:
  - button "Open menu":
    - img "Grafana"
  - navigation "Breadcrumbs":
    - list:
      - listitem:
        - link "Home":
          - /url: /
      - listitem:
        - link "Alerting":
          - /url: /alerting
      - listitem:
        - link "Alert rules":
          - /url: /alerting/list
      - listitem: New alert rule
  - button "Search or jump to..."
  - text: ctrl+k
  - button "New"
  - button "Help"
  - button "Enable kiosk mode"
  - button "Profile":
    - img "User avatar"
  - button "Save rule and exit"
  - button "Cancel"
- main:
  - heading "New alert rule" [level=1]
  - group "1. Enter alert rule name":
    - text: 1. Enter alert rule name Enter a name to identify your alert rule. Name
    - textbox "name"
  - group "2. Define query and alert condition Advanced options Advanced options":
    - text: 2. Define query and alert condition Advanced options
    - switch "Advanced options"
    - text: Define query and alert condition Need help?
    - img "CloudWatch logo"
    - textbox "Select a data source"
    - img
    - button "Options"
    - text: "10 minutes Region:"
    - log
    - text: default
    - combobox "Region:"
    - log
    - text: CloudWatch Metrics
    - combobox "Query mode"
    - log
    - text: Metric Search
    - combobox "Metric editor mode"
    - button "Run queries"
    - radiogroup:
      - radio "Builder" [checked]
      - text: Builder
      - radio "Code"
      - text: Code
    - text: Namespace
    - log
    - text: Choose
    - combobox "Namespace"
    - text: Metric name
    - log
    - text: Choose
    - combobox "Metric name"
    - text: Statistic
    - log
    - text: Average
    - combobox "Statistic"
    - text: Dimensions
    - button "Add"
    - text: Match exact - optional
    - img
    - switch "Match exact - optional" [checked]
    - text: ID - optional
    - img
    - textbox "ID - optional"
    - text: Period
    - img
    - textbox "Period"
    - text: Label - optional
    - img
    - code:
      - textbox "Editor content;Press Alt+F1 for Accessibility Options."
    - text: Alert condition WHEN
    - log
    - text: Last
    - combobox
    - text: OF QUERY
    - button "Is above"
    - spinbutton: "0"
    - button "Preview alert rule condition"
  - group "3. Add folder and labels":
    - text: 3. Add folder and labels Organize your alert rule with a folder and set of labels. Need help? Folder Select a folder to store your rule in.
    - button "Select folder"
    - text: or
    - button "New folder"
    - heading "Labels" [level=5]
    - text: Add labels to your rule for searching, silencing, or routing to a notification policy. Need help?
    - list "Labels"
    - text: No labels selected
    - button "Add labels"
  - group "4. Set evaluation behavior":
    - text: 4. Set evaluation behavior Define how the alert rule is evaluated. Need help? Select a folder before setting evaluation group and interval
    - log
    - text: Select an evaluation group... or
    - button "New evaluation group" [disabled]
    - text: Pending period Period during which the threshold condition must be met to trigger an alert. Selecting "None" triggers the alert immediately once the condition is met.
    - textbox "Pending period Period during which the threshold condition must be met to trigger an alert. Selecting \"None\" triggers the alert immediately once the condition is met.": 1m
    - listbox:
      - option "None"
      - option "1m" [selected]
      - option "2m"
      - option "3m"
      - option "4m"
      - option "5m"
    - button "Configure no data and error handling"
  - group "5. Configure notifications Advanced options Advanced options":
    - text: 5. Configure notifications Advanced options
    - switch "Advanced options"
    - text: Select who should receive a notification when an alert rule fires.
    - heading "Recipient" [level=5]
    - text: "Notifications for firing alerts are routed to a selected contact point. Need help? Alertmanager:"
    - img "Alert manager logo"
    - text: grafana Contact point
    - log
    - text: Choose
    - combobox
    - button "Refresh contact points list"
    - link "View or create contact points":
      - /url: /alerting/notifications
    - button "Muting, grouping and timings (optional)"
    - text: Muting, grouping and timings (optional)
  - group "6. Configure notification message":
    - text: 6. Configure notification message Add more context to your alert notifications. Need help? Summary (optional) Short summary of what happened and why.
    - textbox "Enter a summary..."
    - text: Description (optional) Description of what the alert rule does.
    - textbox "Enter a description..."
    - text: Runbook URL (optional) Webpage where you keep your runbook for the alert.
    - textbox "https://"
    - button "Add custom annotation"
    - button "Link dashboard and panel"
- alert
- alert
- complementary
- complementary
```

# Test source

```ts
   1 | import * as semver from 'semver';
   2 | import { test, expect } from '../../../../src';
   3 |
   4 | const skipMsg = 'Alerting rule test API are only compatible with Grafana 9.5.0 and later';
   5 |
   6 | test.describe('Test alert rule APIs', () => {
   7 |   test('advanced mode should be enabled', async ({ grafanaVersion, alertRuleEditPage }) => {
   8 |     test.skip(semver.lt(grafanaVersion, '11.6.0'), 'Advanced mode is not supported in Grafana versions < 11.6.0');
   9 |     expect(await alertRuleEditPage.isAdvancedModeSupported()).toBe(true);
   10 |   });
   11 |
   12 |   test('should be possible to enable advanced mode', async ({ grafanaVersion, alertRuleEditPage }) => {
   13 |     test.skip(semver.lt(grafanaVersion, '11.6.0'), 'Advanced mode is not supported in Grafana versions < 11.6.0');
   14 |     await expect(alertRuleEditPage.advancedModeSwitch).not.toBeChecked();
   15 |     await alertRuleEditPage.enableAdvancedQueryMode();
   16 |     await expect(alertRuleEditPage.advancedModeSwitch).toBeChecked();
   17 |   });
   18 |
   19 |   test('should be possible to disable advanced mode', async ({ grafanaVersion, alertRuleEditPage }) => {
   20 |     test.skip(semver.lt(grafanaVersion, '11.6.0'), 'Advanced mode is not supported in Grafana versions < 11.6.0');
   21 |     await alertRuleEditPage.enableAdvancedQueryMode();
>  22 |     await expect(alertRuleEditPage.advancedModeSwitch).toBeChecked();
      |                                                        ^ Error: Expected: true
   23 |     await alertRuleEditPage.disableAdvancedQueryMode();
   24 |     await expect(alertRuleEditPage.advancedModeSwitch).not.toBeChecked();
   25 |   });
   26 | });
   27 |
   28 | test.describe('Test new alert rules', () => {
   29 |   test('should evaluate to true if query is valid', async ({
   30 |     grafanaVersion,
   31 |     page,
   32 |     alertRuleEditPage,
   33 |     readProvisionedDataSource,
   34 |   }) => {
   35 |     test.skip(semver.lt(grafanaVersion, '9.5.0'), skipMsg);
   36 |     const ds = await readProvisionedDataSource({ fileName: 'testdatasource.yaml' });
   37 |     const queryA = await alertRuleEditPage.getQueryRow('A');
   38 |     await queryA.datasource.set(ds.name);
   39 |     await page.getByRole('textbox', { name: 'Query Text' }).fill('some query');
   40 |     await expect(alertRuleEditPage.evaluate()).toBeOK();
   41 |   });
   42 |
   43 |   test('should evaluate to false if query is invalid', async ({
   44 |     grafanaVersion,
   45 |     page,
   46 |     alertRuleEditPage,
   47 |     readProvisionedDataSource,
   48 |   }) => {
   49 |     test.skip(semver.lt(grafanaVersion, '9.5.0'), skipMsg);
   50 |     const ds = await readProvisionedDataSource({ fileName: 'testdatasource.yaml' });
   51 |     const queryA = await alertRuleEditPage.getQueryRow('A');
   52 |     await queryA.datasource.set(ds.name);
   53 |     await page.getByRole('textbox', { name: 'Query Text' }).fill('error');
   54 |     await expect(alertRuleEditPage.evaluate()).not.toBeOK();
   55 |   });
   56 |
   57 |   test('should be possible to add multiple rows', async ({
   58 |     grafanaVersion,
   59 |     alertRuleEditPage,
   60 |     selectors,
   61 |     readProvisionedDataSource,
   62 |   }) => {
   63 |     test.skip(semver.lt(grafanaVersion, '9.5.0'), skipMsg);
   64 |     const { rows } = selectors.components.QueryEditorRows;
   65 |     const ds = await readProvisionedDataSource({ fileName: 'testdatasource.yaml' });
   66 |     await alertRuleEditPage.enableAdvancedQueryMode();
   67 |     const queryA = await alertRuleEditPage.getQueryRow();
   68 |     await queryA.datasource.set(ds.name);
   69 |     const rowCount = await alertRuleEditPage.getByGrafanaSelector(rows).count();
   70 |     await alertRuleEditPage.clickAddQueryRow();
   71 |     await expect(alertRuleEditPage.getByGrafanaSelector(rows)).toHaveCount(rowCount + 1);
   72 |     await alertRuleEditPage.clickAddQueryRow();
   73 |     await expect(alertRuleEditPage.getByGrafanaSelector(rows)).toHaveCount(rowCount + 2);
   74 |   });
   75 | });
   76 |
   77 | test.describe('Tests existing alert rules', () => {
   78 |   test('should evaluate to true when loading a provisioned query that is valid', async ({
   79 |     grafanaVersion,
   80 |     gotoAlertRuleEditPage,
   81 |     readProvisionedAlertRule,
   82 |   }) => {
   83 |     test.skip(semver.lt(grafanaVersion, '9.5.0'), skipMsg);
   84 |     const alertRule = await readProvisionedAlertRule({
   85 |       fileName: 'testdatasource.yml',
   86 |       ruleTitle: 'successful-alert',
   87 |     });
   88 |     const alertRuleEditPage = await gotoAlertRuleEditPage(alertRule);
   89 |     await expect(alertRuleEditPage.evaluate()).toBeOK();
   90 |   });
   91 |
   92 |   test('should evaluate to false when loading a provisioned query that is invalid', async ({
   93 |     grafanaVersion,
   94 |     gotoAlertRuleEditPage,
   95 |     readProvisionedAlertRule,
   96 |   }) => {
   97 |     test.skip(semver.lt(grafanaVersion, '9.5.0'), skipMsg);
   98 |     const alertRule = await readProvisionedAlertRule({ fileName: 'testdatasource.yml', ruleTitle: 'broken-alert' });
   99 |     const alertRuleEditPage = await gotoAlertRuleEditPage(alertRule);
  100 |     await expect(alertRuleEditPage.evaluate()).not.toBeOK();
  101 |   });
  102 | });
  103 |
```

# Local changes

```diff
diff --git a/package-lock.json b/package-lock.json
index e3a2d82d..8e2cdc48 100644
--- a/package-lock.json
+++ b/package-lock.json
@@ -23,6 +23,7 @@
         "@auto-it/omit-commits": "11.3.0",
         "@auto-it/slack": "11.3.0",
         "@grafana/eslint-config": "^8.0.0",
+        "@playwright/test": "^1.52.0",
         "@rollup/plugin-commonjs": "^28.0.3",
         "@rollup/plugin-json": "^6.1.0",
         "@rollup/plugin-node-resolve": "^16.0.1",
diff --git a/package.json b/package.json
index 55bf79ab..94a402c9 100644
--- a/package.json
+++ b/package.json
@@ -28,6 +28,7 @@
     "@auto-it/omit-commits": "11.3.0",
     "@auto-it/slack": "11.3.0",
     "@grafana/eslint-config": "^8.0.0",
+    "@playwright/test": "^1.52.0",
     "@rollup/plugin-commonjs": "^28.0.3",
     "@rollup/plugin-json": "^6.1.0",
     "@rollup/plugin-node-resolve": "^16.0.1",
diff --git a/packages/create-plugin/templates/common/playwright.config b/packages/create-plugin/templates/common/playwright.config
index c84567bf..9c8c609f 100644
--- a/packages/create-plugin/templates/common/playwright.config
+++ b/packages/create-plugin/templates/common/playwright.config
@@ -46,10 +46,6 @@ export default defineConfig<PluginOptions>({
       use: {
         ...devices['Desktop Chrome'],
         storageState: 'playwright/.auth/admin.json',
-        launchOptions: {
-          args: ['--disable-features=PlzDedicatedWorker'], // because https://github.com/microsoft/playwright/pull/34400
-        },
-        channel: 'chrome',
       },
       dependencies: ['auth'],
     },
diff --git a/packages/plugin-e2e/playwright.config.ts b/packages/plugin-e2e/playwright.config.ts
index 4621f529..667c7401 100644
--- a/packages/plugin-e2e/playwright.config.ts
+++ b/packages/plugin-e2e/playwright.config.ts
@@ -72,11 +72,7 @@ export default defineConfig<PluginOptions>({
       testDir: './tests/as-admin-user',
       use: {
         ...devices['Desktop Chrome'],
-        launchOptions: {
-          args: ['--disable-features=PlzDedicatedWorker'], // because https://github.com/microsoft/playwright/pull/34400
-        },
         storageState: 'playwright/.auth/admin.json',
-        channel: 'chrome',
       },
       dependencies: ['authenticate'],
     },
@@ -87,15 +83,11 @@ export default defineConfig<PluginOptions>({
       testDir: './tests/as-admin-user',
       use: {
         ...devices['Desktop Chrome'],
-        launchOptions: {
-          args: ['--disable-features=PlzDedicatedWorker'], // because https://github.com/microsoft/playwright/pull/34400
-        },
         storageState: 'playwright/.auth/admin.json',
         viewport: {
           width: 1920,
           height: 1080,
         },
-        channel: 'chrome',
       },
       dependencies: ['authenticate'],
     },
@@ -105,11 +97,7 @@ export default defineConfig<PluginOptions>({
       testDir: './tests/as-viewer-user',
       use: {
         ...devices['Desktop Chrome'],
-        launchOptions: {
-          args: ['--disable-features=PlzDedicatedWorker'], // because https://github.com/microsoft/playwright/pull/34400
-        },
         storageState: 'playwright/.auth/viewer.json',
-        channel: 'chrome',
       },
       dependencies: ['createUserAndAuthenticate'],
     },
diff --git a/packages/plugin-e2e/src/models/components/DataSourcePicker.ts b/packages/plugin-e2e/src/models/components/DataSourcePicker.ts
index 4b0910fd..0df58a42 100644
--- a/packages/plugin-e2e/src/models/components/DataSourcePicker.ts
+++ b/packages/plugin-e2e/src/models/components/DataSourcePicker.ts
@@ -15,12 +15,12 @@ export class DataSourcePicker extends GrafanaPage {
    * Sets the data source picker to the provided name
    */
   async set(name: string) {
-    let datasourcePicker = (this.root || this.ctx.page).getByTestId(
+    let datasourcePicker = await (this.root || this.ctx.page).getByTestId(
       this.ctx.selectors.components.DataSourcePicker.inputV2
     );
 
     if (semver.lt(this.ctx.grafanaVersion, '10.1.0')) {
-      datasourcePicker = this.getByGrafanaSelector(this.ctx.selectors.components.DataSourcePicker.container, {
+      datasourcePicker = await this.getByGrafanaSelector(this.ctx.selectors.components.DataSourcePicker.container, {
         root: this.root,
       }).locator('input');
     }
diff --git a/packages/plugin-e2e/src/models/pages/DashboardPage.ts b/packages/plugin-e2e/src/models/pages/DashboardPage.ts
index 3446d67a..023befc1 100644
--- a/packages/plugin-e2e/src/models/pages/DashboardPage.ts
+++ b/packages/plugin-e2e/src/models/pages/DashboardPage.ts
@@ -94,9 +94,15 @@ export class DashboardPage extends GrafanaPage {
       await this.getByGrafanaSelector(components.NavToolbar.editDashboard.editButton).click();
     }
     // on small screens, the toolbar buttons are hidden behind a "Show more items" button
-    const toolbarButtonsHidden = !scenesEnabled && !!(await this.ctx.page.getByLabel('Show more items').count());
-    if (toolbarButtonsHidden) {
-      await this.ctx.page.getByLabel('Show more items').click();
+    const viewportDimensions = await this.ctx.page.viewportSize();
+    let toolbarButtonsHidden = false;
+
+    if (viewportDimensions && viewportDimensions.width <= 620) {
+      const showMoreItems = await this.ctx.page.getByLabel('Show more items');
+      toolbarButtonsHidden = !scenesEnabled && (await showMoreItems.count()) > 0;
+      if (toolbarButtonsHidden) {
+        await showMoreItems.click();
+      }
     }
 
     if (semver.gte(this.ctx.grafanaVersion, '9.5.0')) {
diff --git a/packages/plugin-e2e/src/models/pages/GrafanaPage.ts b/packages/plugin-e2e/src/models/pages/GrafanaPage.ts
index 7603e2a2..59ea2e0c 100644
--- a/packages/plugin-e2e/src/models/pages/GrafanaPage.ts
+++ b/packages/plugin-e2e/src/models/pages/GrafanaPage.ts
@@ -19,7 +19,7 @@ export abstract class GrafanaPage {
       url += `?${queryParams.toString()}`;
     }
     await this.ctx.page.goto(url, {
-      waitUntil: 'networkidle',
+      waitUntil: 'load',
       ...this.pageArgs,
       ...options,
     });
diff --git a/packages/plugin-e2e/src/models/pages/VariableEditPage.ts b/packages/plugin-e2e/src/models/pages/VariableEditPage.ts
index f2dba860..10e552f6 100644
--- a/packages/plugin-e2e/src/models/pages/VariableEditPage.ts
+++ b/packages/plugin-e2e/src/models/pages/VariableEditPage.ts
@@ -1,4 +1,5 @@
 import * as semver from 'semver';
+import { expect } from '@playwright/test';
 import { DashboardEditViewArgs, NavigateOptions, PluginTestCtx } from '../../types';
 import { DataSourcePicker } from '../components/DataSourcePicker';
 import { GrafanaPage } from './GrafanaPage';
@@ -30,9 +31,10 @@ export class VariableEditPage extends GrafanaPage {
     // In versions before 9.2.0, the variable index is not part of the URL so there's no way to navigate to it directly.
     // Instead, we have to click the nth row in the variable list to navigate to the edit page for a given variable index.
     if (semver.lt(this.ctx.grafanaVersion, '9.2.0') && this.args.id) {
-      const list = this.getByGrafanaSelector(this.ctx.selectors.pages.Dashboard.Settings.Variables.List.table).locator(
-        'tbody tr'
-      );
+      const list = await this.getByGrafanaSelector(
+        this.ctx.selectors.pages.Dashboard.Settings.Variables.List.table
+      ).locator('tbody tr');
+      await expect(list).toBeVisible();
       const variables = await list.all();
       await variables[Number(this.args.id)].click();
     }
diff --git a/packages/plugin-e2e/tests/as-admin-user/app/app-config/appConfig.spec.ts b/packages/plugin-e2e/tests/as-admin-user/app/app-config/appConfig.spec.ts
index c8c06927..e176a8b8 100644
--- a/packages/plugin-e2e/tests/as-admin-user/app/app-config/appConfig.spec.ts
+++ b/packages/plugin-e2e/tests/as-admin-user/app/app-config/appConfig.spec.ts
@@ -16,6 +16,6 @@ test('should wait for plugin config settings API to respond', async ({ gotoAppCo
   );
 
   const response = configPage.waitForSettingsResponse();
-  await page.getByRole('button', { name: 'Disable' }).first().click();
+  await page.getByRole('button', { name: /Disable|Enable/i }).first().click();
   await expect(response).toBeOK();
 });
diff --git a/packages/plugin-e2e/tests/as-admin-user/datasource/query-editor/queryEditor.integration.spec.ts b/packages/plugin-e2e/tests/as-admin-user/datasource/query-editor/queryEditor.integration.spec.ts
index 51eb8f92..68316e84 100644
--- a/packages/plugin-e2e/tests/as-admin-user/datasource/query-editor/queryEditor.integration.spec.ts
+++ b/packages/plugin-e2e/tests/as-admin-user/datasource/query-editor/queryEditor.integration.spec.ts
@@ -33,3 +33,5 @@ test('should be possible to load and execute an existing valid query', async ({
   await expect(panelEditPage.refreshPanel()).toBeOK();
   await expect(panelEditPage.panel.getErrorIcon()).not.toBeVisible();
 });
+
+// DEBUG=pw:browser
```