name: Lapo Docs Create docs PR for merged PR

on:
  repository_dispatch:
    types: [pr-merged]
  workflow_dispatch:
    inputs:
      pr_url:
        description: 'PR URL'
        required: true

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  print-params:
    runs-on: ubuntu-latest
    steps:
      - name: Generate token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PEM }}

      # this allows to test both with manual trigger and repository_dispatch
      - name: Set PR URL
        id: set-pr-url
        run: |
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "url=${{ github.event.client_payload.pr_url }}" >> $GITHUB_OUTPUT
          else
            echo "url=${{ github.event.inputs.pr_url }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Print PR URL
        run: |
          echo "PR URL: ${{ steps.set-pr-url.outputs.url }}"

      - uses: grafana/lapo-docs/github-actions/create-docs-update-pr@main
        id: generate-embeddings
        with:
          token: ${{ steps.generate_token.outputs.token }}
          docs-path: docusaurus/docs
          gemini-api-key: ${{ secrets.GEMINI_API_KEY }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          embeddings-action: lapo-generate-embeddings.yml
          source-change-pr: ${{ steps.set-pr-url.outputs.url }}

