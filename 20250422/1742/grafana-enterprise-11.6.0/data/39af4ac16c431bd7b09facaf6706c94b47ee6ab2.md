# Test info

- Name: should display TLS enabled field when tlsEnabled feature toggle is set to true
- Location: /home/runner/work/plugin-tools/plugin-tools/packages/plugin-e2e/tests/as-admin-user/datasource/feature-toggles/queryEditor.tlsEnabled.spec.ts:21:5

# Error details

```
Error: Timed out 5000ms waiting for expect(locator).toBeVisible()

Locator: locator('[aria-label="Query editor row"]').filter({ has: locator('[aria-label="Query editor row title A"]') }).getByLabel('TLS Enabled')
Expected: visible
Received: <element(s) not found>
Call log:
  - expect.toBeVisible with timeout 5000ms
  - waiting for locator('[aria-label="Query editor row"]').filter({ has: locator('[aria-label="Query editor row title A"]') }).getByLabel('TLS Enabled')

    at /home/runner/work/plugin-tools/plugin-tools/packages/plugin-e2e/tests/as-admin-user/datasource/feature-toggles/queryEditor.tlsEnabled.spec.ts:32:25
```

# Page snapshot

```yaml
- main:
  - img "Grafana"
  - heading "Welcome to Grafana" [level=1]
  - text: Email or username
  - textbox "Email or username"
  - text: Password
  - textbox "Password"
  - switch "Show password"
  - button "Log in"
  - link "Forgot your password?":
    - /url: /user/password/send-reset-email
  - list:
    - listitem:
      - link "Documentation":
        - /url: https://grafana.com/docs/grafana/latest/?utm_source=grafana_footer
      - text: "|"
    - listitem:
      - link "Support":
        - /url: https://grafana.com/products/enterprise/?utm_source=grafana_footer
      - text: "|"
    - listitem:
      - link "Community":
        - /url: https://community.grafana.com/?utm_source=grafana_footer
      - text: "|"
    - listitem:
      - link "Enterprise (Free & unlicensed)":
        - /url: https://grafana.com/products/enterprise/?utm_source=grafana_footer
      - text: "|"
    - listitem:
      - link "Grafana v11.6.0 (d2fdff9ee4)":
        - /url: https://github.com/grafana/grafana/blob/main/CHANGELOG.md
```

# Test source

```ts
   1 | import * as semver from 'semver';
   2 | import { expect, test } from '../../../../src';
   3 |
   4 | const TRUTHY_CUSTOM_TOGGLE = 'custom_toggle1';
   5 | const FALSY_CUSTOM_TOGGLE = 'custom_toggle2';
   6 |
   7 | // override the feature toggles defined in playwright.config.ts only for tests in this file
   8 | test.use({
   9 |   featureToggles: {
  10 |     tlsEnabled: true,
  11 |     [TRUTHY_CUSTOM_TOGGLE]: true,
  12 |     [FALSY_CUSTOM_TOGGLE]: false,
  13 |   },
  14 | });
  15 |
  16 | test('should set feature toggles correctly', async ({ isFeatureToggleEnabled }) => {
  17 |   expect(await isFeatureToggleEnabled(TRUTHY_CUSTOM_TOGGLE)).toBeTruthy();
  18 |   expect(await isFeatureToggleEnabled(FALSY_CUSTOM_TOGGLE)).toBeFalsy();
  19 | });
  20 |
  21 | test('should display TLS enabled field when tlsEnabled feature toggle is set to true', async ({
  22 |   gotoPanelEditPage,
  23 |   readProvisionedDashboard,
  24 |   grafanaVersion,
  25 | }) => {
  26 |   const dashboard = await readProvisionedDashboard({ fileName: 'testdatasource.json' });
  27 |   const panelEditPage = await gotoPanelEditPage({ dashboard, id: '1' });
  28 |   const row = panelEditPage.getQueryEditorRow('A');
  29 |   const locator = semver.lt(grafanaVersion, '9.3.0')
  30 |     ? row.locator(`[label="TLS Enabled"]`).locator('../label')
  31 |     : row.getByLabel('TLS Enabled');
> 32 |   await expect(locator).toBeVisible();
     |                         ^ Error: Timed out 5000ms waiting for expect(locator).toBeVisible()
  33 | });
  34 |
```

# Local changes

```diff
diff --git a/package-lock.json b/package-lock.json
index e3a2d82d..8e2cdc48 100644
--- a/package-lock.json
+++ b/package-lock.json
@@ -23,6 +23,7 @@
         "@auto-it/omit-commits": "11.3.0",
         "@auto-it/slack": "11.3.0",
         "@grafana/eslint-config": "^8.0.0",
+        "@playwright/test": "^1.52.0",
         "@rollup/plugin-commonjs": "^28.0.3",
         "@rollup/plugin-json": "^6.1.0",
         "@rollup/plugin-node-resolve": "^16.0.1",
diff --git a/package.json b/package.json
index 55bf79ab..94a402c9 100644
--- a/package.json
+++ b/package.json
@@ -28,6 +28,7 @@
     "@auto-it/omit-commits": "11.3.0",
     "@auto-it/slack": "11.3.0",
     "@grafana/eslint-config": "^8.0.0",
+    "@playwright/test": "^1.52.0",
     "@rollup/plugin-commonjs": "^28.0.3",
     "@rollup/plugin-json": "^6.1.0",
     "@rollup/plugin-node-resolve": "^16.0.1",
diff --git a/packages/create-plugin/templates/common/playwright.config b/packages/create-plugin/templates/common/playwright.config
index c84567bf..9c8c609f 100644
--- a/packages/create-plugin/templates/common/playwright.config
+++ b/packages/create-plugin/templates/common/playwright.config
@@ -46,10 +46,6 @@ export default defineConfig<PluginOptions>({
       use: {
         ...devices['Desktop Chrome'],
         storageState: 'playwright/.auth/admin.json',
-        launchOptions: {
-          args: ['--disable-features=PlzDedicatedWorker'], // because https://github.com/microsoft/playwright/pull/34400
-        },
-        channel: 'chrome',
       },
       dependencies: ['auth'],
     },
diff --git a/packages/plugin-e2e/playwright.config.ts b/packages/plugin-e2e/playwright.config.ts
index 4621f529..3addcbbf 100644
--- a/packages/plugin-e2e/playwright.config.ts
+++ b/packages/plugin-e2e/playwright.config.ts
@@ -87,9 +87,6 @@ export default defineConfig<PluginOptions>({
       testDir: './tests/as-admin-user',
       use: {
         ...devices['Desktop Chrome'],
-        launchOptions: {
-          args: ['--disable-features=PlzDedicatedWorker'], // because https://github.com/microsoft/playwright/pull/34400
-        },
         storageState: 'playwright/.auth/admin.json',
         viewport: {
           width: 1920,
@@ -105,9 +102,6 @@ export default defineConfig<PluginOptions>({
       testDir: './tests/as-viewer-user',
       use: {
         ...devices['Desktop Chrome'],
-        launchOptions: {
-          args: ['--disable-features=PlzDedicatedWorker'], // because https://github.com/microsoft/playwright/pull/34400
-        },
         storageState: 'playwright/.auth/viewer.json',
         channel: 'chrome',
       },
diff --git a/packages/plugin-e2e/src/models/components/DataSourcePicker.ts b/packages/plugin-e2e/src/models/components/DataSourcePicker.ts
index 4b0910fd..0df58a42 100644
--- a/packages/plugin-e2e/src/models/components/DataSourcePicker.ts
+++ b/packages/plugin-e2e/src/models/components/DataSourcePicker.ts
@@ -15,12 +15,12 @@ export class DataSourcePicker extends GrafanaPage {
    * Sets the data source picker to the provided name
    */
   async set(name: string) {
-    let datasourcePicker = (this.root || this.ctx.page).getByTestId(
+    let datasourcePicker = await (this.root || this.ctx.page).getByTestId(
       this.ctx.selectors.components.DataSourcePicker.inputV2
     );
 
     if (semver.lt(this.ctx.grafanaVersion, '10.1.0')) {
-      datasourcePicker = this.getByGrafanaSelector(this.ctx.selectors.components.DataSourcePicker.container, {
+      datasourcePicker = await this.getByGrafanaSelector(this.ctx.selectors.components.DataSourcePicker.container, {
         root: this.root,
       }).locator('input');
     }
diff --git a/packages/plugin-e2e/src/models/pages/DashboardPage.ts b/packages/plugin-e2e/src/models/pages/DashboardPage.ts
index 3446d67a..ccb014a1 100644
--- a/packages/plugin-e2e/src/models/pages/DashboardPage.ts
+++ b/packages/plugin-e2e/src/models/pages/DashboardPage.ts
@@ -94,9 +94,10 @@ export class DashboardPage extends GrafanaPage {
       await this.getByGrafanaSelector(components.NavToolbar.editDashboard.editButton).click();
     }
     // on small screens, the toolbar buttons are hidden behind a "Show more items" button
-    const toolbarButtonsHidden = !scenesEnabled && !!(await this.ctx.page.getByLabel('Show more items').count());
+    const showMoreItems = await this.ctx.page.getByLabel('Show more items');
+    const toolbarButtonsHidden = !scenesEnabled && (await showMoreItems.count()) > 0;
     if (toolbarButtonsHidden) {
-      await this.ctx.page.getByLabel('Show more items').click();
+      await showMoreItems.click();
     }
 
     if (semver.gte(this.ctx.grafanaVersion, '9.5.0')) {
diff --git a/packages/plugin-e2e/src/models/pages/GrafanaPage.ts b/packages/plugin-e2e/src/models/pages/GrafanaPage.ts
index 7603e2a2..59ea2e0c 100644
--- a/packages/plugin-e2e/src/models/pages/GrafanaPage.ts
+++ b/packages/plugin-e2e/src/models/pages/GrafanaPage.ts
@@ -19,7 +19,7 @@ export abstract class GrafanaPage {
       url += `?${queryParams.toString()}`;
     }
     await this.ctx.page.goto(url, {
-      waitUntil: 'networkidle',
+      waitUntil: 'load',
       ...this.pageArgs,
       ...options,
     });
diff --git a/packages/plugin-e2e/src/models/pages/VariableEditPage.ts b/packages/plugin-e2e/src/models/pages/VariableEditPage.ts
index f2dba860..fe6db5f5 100644
--- a/packages/plugin-e2e/src/models/pages/VariableEditPage.ts
+++ b/packages/plugin-e2e/src/models/pages/VariableEditPage.ts
@@ -30,7 +30,7 @@ export class VariableEditPage extends GrafanaPage {
     // In versions before 9.2.0, the variable index is not part of the URL so there's no way to navigate to it directly.
     // Instead, we have to click the nth row in the variable list to navigate to the edit page for a given variable index.
     if (semver.lt(this.ctx.grafanaVersion, '9.2.0') && this.args.id) {
-      const list = this.getByGrafanaSelector(this.ctx.selectors.pages.Dashboard.Settings.Variables.List.table).locator(
+      const list = await this.getByGrafanaSelector(this.ctx.selectors.pages.Dashboard.Settings.Variables.List.table).locator(
         'tbody tr'
       );
       const variables = await list.all();
diff --git a/packages/plugin-e2e/tests/as-admin-user/app/app-config/appConfig.spec.ts b/packages/plugin-e2e/tests/as-admin-user/app/app-config/appConfig.spec.ts
index c8c06927..e176a8b8 100644
--- a/packages/plugin-e2e/tests/as-admin-user/app/app-config/appConfig.spec.ts
+++ b/packages/plugin-e2e/tests/as-admin-user/app/app-config/appConfig.spec.ts
@@ -16,6 +16,6 @@ test('should wait for plugin config settings API to respond', async ({ gotoAppCo
   );
 
   const response = configPage.waitForSettingsResponse();
-  await page.getByRole('button', { name: 'Disable' }).first().click();
+  await page.getByRole('button', { name: /Disable|Enable/i }).first().click();
   await expect(response).toBeOK();
 });
diff --git a/packages/plugin-e2e/tests/as-admin-user/datasource/query-editor/queryEditor.integration.spec.ts b/packages/plugin-e2e/tests/as-admin-user/datasource/query-editor/queryEditor.integration.spec.ts
index 51eb8f92..68316e84 100644
--- a/packages/plugin-e2e/tests/as-admin-user/datasource/query-editor/queryEditor.integration.spec.ts
+++ b/packages/plugin-e2e/tests/as-admin-user/datasource/query-editor/queryEditor.integration.spec.ts
@@ -33,3 +33,5 @@ test('should be possible to load and execute an existing valid query', async ({
   await expect(panelEditPage.refreshPanel()).toBeOK();
   await expect(panelEditPage.panel.getErrorIcon()).not.toBeVisible();
 });
+
+// DEBUG=pw:browser
```