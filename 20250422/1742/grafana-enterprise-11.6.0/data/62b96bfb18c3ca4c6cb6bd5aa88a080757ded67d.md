# Test info

- Name: Test new alert rules >> should be possible to add multiple rows
- Location: /home/runner/work/plugin-tools/plugin-tools/packages/plugin-e2e/tests/as-admin-user/datasource/alerting/alerting.basicMode.spec.ts:42:7

# Error details

```
Error: Timed out 5000ms waiting for expect(locator).toHaveCount(expected)

Locator: locator('[aria-label="Query editor row"]')
Expected: 1
Received: 2
Call log:
  - expect.toHaveCount with timeout 5000ms
  - waiting for locator('[aria-label="Query editor row"]')
    9 Ã— locator resolved to 2 elements
      - unexpected value "2"

    at /home/runner/work/plugin-tools/plugin-tools/packages/plugin-e2e/tests/as-admin-user/datasource/alerting/alerting.basicMode.spec.ts:55:64
```

# Page snapshot

```yaml
- link "Skip to main content":
  - /url: "#pageContent"
- button "Close menu":
  - img "Grafana"
- text: Grafana
- button "Undock menu"
- navigation:
  - list "Navigation":
    - listitem:
      - link "Home":
        - /url: /
    - listitem:
      - link "Bookmarks":
        - /url: /bookmarks
      - button "Expand section Bookmarks"
    - listitem:
      - link "Starred":
        - /url: /dashboards?starred
      - button "Expand section Starred"
    - listitem:
      - link "Dashboards":
        - /url: /dashboards
      - button "Expand section Dashboards"
    - listitem:
      - link "Explore":
        - /url: /explore
    - listitem:
      - link "Drilldown New!":
        - /url: /drilldown
      - button "Expand section Drilldown"
    - listitem:
      - link "Alerting":
        - /url: /alerting
      - button "Collapse section Alerting"
      - list:
        - listitem:
          - link "Alert rules":
            - /url: /alerting/list
        - listitem:
          - link "Contact points":
            - /url: /alerting/notifications
        - listitem:
          - link "Notification policies":
            - /url: /alerting/routes
        - listitem:
          - link "Silences":
            - /url: /alerting/silences
        - listitem:
          - link "Active notifications":
            - /url: /alerting/groups
        - listitem:
          - link "Settings":
            - /url: /alerting/admin
    - listitem:
      - link "Connections":
        - /url: /connections
      - button "Expand section Connections"
    - listitem:
      - link "More apps":
        - /url: /apps
      - button "Expand section More apps"
    - listitem:
      - link "Administration":
        - /url: /admin
      - button "Expand section Administration"
- banner:
  - navigation "Breadcrumbs":
    - list:
      - listitem:
        - link "Home":
          - /url: /
      - listitem:
        - link "Alerting":
          - /url: /alerting
      - listitem:
        - link "Alert rules":
          - /url: /alerting/list
      - listitem: New alert rule
  - button "Search or jump to..."
  - text: ctrl+k
  - button "New"
  - button "Help"
  - button "Enable kiosk mode"
  - button "Profile":
    - img "User avatar"
  - button "Save rule and exit"
  - button "Cancel"
- main:
  - heading "New alert rule" [level=1]
  - group "1. Enter alert rule name":
    - text: 1. Enter alert rule name Enter a name to identify your alert rule. Name
    - textbox "name"
  - group "2. Define query and alert condition":
    - text: 2. Define query and alert condition Define query and alert condition Need help?
    - button "Query editor row title A": A
    - img "CloudWatch logo"
    - textbox "Select a data source"
    - img
    - button "Options"
    - text: 10 minutes
    - button "Set as alert condition"
    - button "Show data source help"
    - button "Duplicate query"
    - button "Remove query"
    - button "Drag and drop to reorder":
      - img "Drag and drop to reorder"
    - text: "Region:"
    - log
    - text: default
    - combobox "Region:"
    - log
    - text: CloudWatch Metrics
    - combobox "Query mode"
    - log
    - text: Metric Search
    - combobox "Metric editor mode"
    - button "Run queries"
    - radiogroup:
      - radio "Builder" [checked]
      - text: Builder
      - radio "Code"
      - text: Code
    - text: Namespace
    - log
    - text: Choose
    - combobox "Namespace"
    - text: Metric name
    - log
    - text: Choose
    - combobox "Metric name"
    - text: Statistic
    - log
    - text: Average
    - combobox "Statistic"
    - text: Dimensions
    - button "Add"
    - text: Match exact - optional
    - img
    - switch "Match exact - optional" [checked]
    - text: ID - optional
    - img
    - textbox "ID - optional"
    - text: Period
    - img
    - textbox "Period"
    - text: Label - optional
    - img
    - code:
      - textbox "Editor content;Press Alt+F1 for Accessibility Options."
    - button "Query editor row title D": D
    - img "CloudWatch logo"
    - textbox "Select a data source"
    - img
    - button "Options"
    - text: 10 minutes
    - button "Set as alert condition"
    - button "Show data source help"
    - button "Duplicate query"
    - button "Remove query"
    - button "Drag and drop to reorder":
      - img "Drag and drop to reorder"
    - text: "Region:"
    - log
    - text: default
    - combobox "Region:"
    - log
    - text: CloudWatch Metrics
    - combobox "Query mode"
    - log
    - text: Metric Search
    - combobox "Metric editor mode"
    - button "Run queries"
    - radiogroup:
      - radio "Builder" [checked]
      - text: Builder
      - radio "Code"
      - text: Code
    - text: Namespace
    - log
    - text: Choose
    - combobox "Namespace"
    - text: Metric name
    - log
    - text: Choose
    - combobox "Metric name"
    - text: Statistic
    - log
    - text: Average
    - combobox "Statistic"
    - text: Dimensions
    - button "Add"
    - text: Match exact - optional
    - img
    - switch "Match exact - optional" [checked]
    - text: ID - optional
    - img
    - textbox "ID - optional"
    - text: Period
    - img
    - textbox "Period"
    - text: Label - optional
    - img
    - code:
      - textbox "Editor content;Press Alt+F1 for Accessibility Options."
    - button "Add query"
    - text: Rule type Select where the alert rule will be managed. Need help?
    - radiogroup:
      - radio "Grafana-managed" [checked]
      - text: Grafana-managed
      - radio "Data source-managed" [disabled]
      - text: Data source-managed
    - text: Based on the selected data sources this alert rule will be Grafana-managed.
    - heading "Expressions" [level=5]
    - text: Manipulate data returned from queries with math and other operations.
    - button "B"
    - text: Reduce
    - button "Set \"B\" as alert condition"
    - button "Remove expression \"B\""
    - text: Takes one or more time series returned from a query or an expression and turns each series into a single number. Input
    - log
    - text: A
    - combobox
    - text: Function
    - log
    - text: Last
    - combobox
    - text: Mode
    - log
    - text: Strict
    - combobox
    - button "C"
    - text: Threshold Alert condition
    - button "Remove expression \"C\""
    - text: Takes one or more time series returned from a query or an expression and checks if any of the series match the threshold condition. Input
    - log
    - text: B
    - combobox "Input"
    - button "Is above"
    - spinbutton: "0"
    - text: Custom recovery threshold
    - switch "Custom recovery threshold"
    - button "Add expression"
    - button "Preview"
  - group "3. Add folder and labels":
    - text: 3. Add folder and labels Organize your alert rule with a folder and set of labels. Need help? Folder Select a folder to store your rule in.
    - button "Select folder"
    - text: or
    - button "New folder"
    - heading "Labels" [level=5]
    - text: Add labels to your rule for searching, silencing, or routing to a notification policy. Need help?
    - list "Labels"
    - text: No labels selected
    - button "Add labels"
  - group "4. Set evaluation behavior":
    - text: 4. Set evaluation behavior Define how the alert rule is evaluated. Need help? Select a folder before setting evaluation group and interval
    - log
    - text: Select an evaluation group... or
    - button "New evaluation group" [disabled]
    - text: Pending period Period during which the threshold condition must be met to trigger an alert. Selecting "None" triggers the alert immediately once the condition is met.
    - textbox "Pending period Period during which the threshold condition must be met to trigger an alert. Selecting \"None\" triggers the alert immediately once the condition is met.": 1m
    - listbox:
      - option "None"
      - option "1m" [selected]
      - option "2m"
      - option "3m"
      - option "4m"
      - option "5m"
    - button "Configure no data and error handling"
  - group "5. Configure notifications":
    - text: 5. Configure notifications Select who should receive a notification when an alert rule fires.
    - heading "Recipient" [level=5]
    - radiogroup:
      - radio "Select contact point" [checked]
      - text: Select contact point
      - radio "Use notification policy"
      - text: Use notification policy
    - text: "Notifications for firing alerts are routed to a selected contact point. Need help? Alertmanager:"
    - img "Alert manager logo"
    - text: grafana Contact point
    - log
    - text: Choose
    - combobox
    - button "Refresh contact points list"
    - link "View or create contact points":
      - /url: /alerting/notifications
    - button "Muting, grouping and timings (optional)"
    - text: Muting, grouping and timings (optional)
  - group "6. Configure notification message":
    - text: 6. Configure notification message Add more context to your alert notifications. Need help? Summary (optional) Short summary of what happened and why.
    - textbox "Enter a summary..."
    - text: Description (optional) Description of what the alert rule does.
    - textbox "Enter a description..."
    - text: Runbook URL (optional) Webpage where you keep your runbook for the alert.
    - textbox "https://"
    - button "Add custom annotation"
    - button "Link dashboard and panel"
- alert
- alert
- complementary
- complementary
```

# Test source

```ts
   1 | import * as semver from 'semver';
   2 | import { test, expect } from '../../../../src';
   3 |
   4 | const skipMsg = 'Alerting rule test API are only compatible with Grafana 9.5.0 and later';
   5 | test.use({ featureToggles: { alertingQueryAndExpressionsStepMode: false, alertingNotificationsStepMode: false } });
   6 | test.describe('Test alert rule APIs', () => {
   7 |   test('advanced mode should be disabled', async ({ grafanaVersion, alertRuleEditPage }) => {
   8 |     test.skip(semver.lt(grafanaVersion, '9.5.0'), skipMsg);
   9 |     expect(await alertRuleEditPage.isAdvancedModeSupported()).toBe(false);
  10 |   });
  11 | });
  12 |
  13 | test.describe('Test new alert rules', () => {
  14 |   test('should evaluate to true if query is valid', async ({
  15 |     grafanaVersion,
  16 |     page,
  17 |     alertRuleEditPage,
  18 |     readProvisionedDataSource,
  19 |   }) => {
  20 |     test.skip(semver.lt(grafanaVersion, '9.5.0'), skipMsg);
  21 |     const ds = await readProvisionedDataSource({ fileName: 'testdatasource.yaml' });
  22 |     const queryA = await alertRuleEditPage.getQueryRow('A');
  23 |     await queryA.datasource.set(ds.name);
  24 |     await page.getByRole('textbox', { name: 'Query Text' }).fill('some query');
  25 |     await expect(alertRuleEditPage.evaluate()).toBeOK();
  26 |   });
  27 |
  28 |   test('should evaluate to false if query is invalid', async ({
  29 |     grafanaVersion,
  30 |     page,
  31 |     alertRuleEditPage,
  32 |     readProvisionedDataSource,
  33 |   }) => {
  34 |     test.skip(semver.lt(grafanaVersion, '9.5.0'), skipMsg);
  35 |     const ds = await readProvisionedDataSource({ fileName: 'testdatasource.yaml' });
  36 |     const queryA = await alertRuleEditPage.getQueryRow('A');
  37 |     await queryA.datasource.set(ds.name);
  38 |     await page.getByRole('textbox', { name: 'Query Text' }).fill('error');
  39 |     await expect(alertRuleEditPage.evaluate()).not.toBeOK();
  40 |   });
  41 |
  42 |   test('should be possible to add multiple rows', async ({
  43 |     grafanaVersion,
  44 |     alertRuleEditPage,
  45 |     selectors,
  46 |     readProvisionedDataSource,
  47 |   }) => {
  48 |     test.skip(semver.lt(grafanaVersion, '9.5.0'), skipMsg);
  49 |     const { rows } = selectors.components.QueryEditorRows;
  50 |     const ds = await readProvisionedDataSource({ fileName: 'testdatasource.yaml' });
  51 |     const queryA = await alertRuleEditPage.getQueryRow();
  52 |     await queryA.datasource.set(ds.name);
  53 |     const rowCount = await alertRuleEditPage.getByGrafanaSelector(rows).count();
  54 |     await alertRuleEditPage.clickAddQueryRow();
> 55 |     await expect(alertRuleEditPage.getByGrafanaSelector(rows)).toHaveCount(rowCount + 1);
     |                                                                ^ Error: Timed out 5000ms waiting for expect(locator).toHaveCount(expected)
  56 |     await alertRuleEditPage.clickAddQueryRow();
  57 |     await expect(alertRuleEditPage.getByGrafanaSelector(rows)).toHaveCount(rowCount + 2);
  58 |   });
  59 | });
  60 |
  61 | test.describe('Tests existing alert rules', () => {
  62 |   test('should evaluate to true when loading a provisioned query that is valid', async ({
  63 |     grafanaVersion,
  64 |     gotoAlertRuleEditPage,
  65 |     readProvisionedAlertRule,
  66 |   }) => {
  67 |     test.skip(semver.lt(grafanaVersion, '9.5.0'), skipMsg);
  68 |     const alertRule = await readProvisionedAlertRule({
  69 |       fileName: 'testdatasource.yml',
  70 |       ruleTitle: 'successful-alert',
  71 |     });
  72 |     const alertRuleEditPage = await gotoAlertRuleEditPage(alertRule);
  73 |     await expect(alertRuleEditPage.evaluate()).toBeOK();
  74 |   });
  75 |
  76 |   test('should evaluate to false when loading a provisioned query that is invalid', async ({
  77 |     grafanaVersion,
  78 |     gotoAlertRuleEditPage,
  79 |     readProvisionedAlertRule,
  80 |   }) => {
  81 |     test.skip(semver.lt(grafanaVersion, '9.5.0'), skipMsg);
  82 |     const alertRule = await readProvisionedAlertRule({ fileName: 'testdatasource.yml', ruleTitle: 'broken-alert' });
  83 |     const alertRuleEditPage = await gotoAlertRuleEditPage(alertRule);
  84 |     await expect(alertRuleEditPage.evaluate()).not.toBeOK();
  85 |   });
  86 | });
  87 |
```

# Local changes

```diff
diff --git a/package-lock.json b/package-lock.json
index e3a2d82d..8e2cdc48 100644
--- a/package-lock.json
+++ b/package-lock.json
@@ -23,6 +23,7 @@
         "@auto-it/omit-commits": "11.3.0",
         "@auto-it/slack": "11.3.0",
         "@grafana/eslint-config": "^8.0.0",
+        "@playwright/test": "^1.52.0",
         "@rollup/plugin-commonjs": "^28.0.3",
         "@rollup/plugin-json": "^6.1.0",
         "@rollup/plugin-node-resolve": "^16.0.1",
diff --git a/package.json b/package.json
index 55bf79ab..94a402c9 100644
--- a/package.json
+++ b/package.json
@@ -28,6 +28,7 @@
     "@auto-it/omit-commits": "11.3.0",
     "@auto-it/slack": "11.3.0",
     "@grafana/eslint-config": "^8.0.0",
+    "@playwright/test": "^1.52.0",
     "@rollup/plugin-commonjs": "^28.0.3",
     "@rollup/plugin-json": "^6.1.0",
     "@rollup/plugin-node-resolve": "^16.0.1",
diff --git a/packages/create-plugin/templates/common/playwright.config b/packages/create-plugin/templates/common/playwright.config
index c84567bf..9c8c609f 100644
--- a/packages/create-plugin/templates/common/playwright.config
+++ b/packages/create-plugin/templates/common/playwright.config
@@ -46,10 +46,6 @@ export default defineConfig<PluginOptions>({
       use: {
         ...devices['Desktop Chrome'],
         storageState: 'playwright/.auth/admin.json',
-        launchOptions: {
-          args: ['--disable-features=PlzDedicatedWorker'], // because https://github.com/microsoft/playwright/pull/34400
-        },
-        channel: 'chrome',
       },
       dependencies: ['auth'],
     },
diff --git a/packages/plugin-e2e/playwright.config.ts b/packages/plugin-e2e/playwright.config.ts
index 4621f529..3addcbbf 100644
--- a/packages/plugin-e2e/playwright.config.ts
+++ b/packages/plugin-e2e/playwright.config.ts
@@ -87,9 +87,6 @@ export default defineConfig<PluginOptions>({
       testDir: './tests/as-admin-user',
       use: {
         ...devices['Desktop Chrome'],
-        launchOptions: {
-          args: ['--disable-features=PlzDedicatedWorker'], // because https://github.com/microsoft/playwright/pull/34400
-        },
         storageState: 'playwright/.auth/admin.json',
         viewport: {
           width: 1920,
@@ -105,9 +102,6 @@ export default defineConfig<PluginOptions>({
       testDir: './tests/as-viewer-user',
       use: {
         ...devices['Desktop Chrome'],
-        launchOptions: {
-          args: ['--disable-features=PlzDedicatedWorker'], // because https://github.com/microsoft/playwright/pull/34400
-        },
         storageState: 'playwright/.auth/viewer.json',
         channel: 'chrome',
       },
diff --git a/packages/plugin-e2e/src/models/pages/DashboardPage.ts b/packages/plugin-e2e/src/models/pages/DashboardPage.ts
index 3446d67a..ccb014a1 100644
--- a/packages/plugin-e2e/src/models/pages/DashboardPage.ts
+++ b/packages/plugin-e2e/src/models/pages/DashboardPage.ts
@@ -94,9 +94,10 @@ export class DashboardPage extends GrafanaPage {
       await this.getByGrafanaSelector(components.NavToolbar.editDashboard.editButton).click();
     }
     // on small screens, the toolbar buttons are hidden behind a "Show more items" button
-    const toolbarButtonsHidden = !scenesEnabled && !!(await this.ctx.page.getByLabel('Show more items').count());
+    const showMoreItems = await this.ctx.page.getByLabel('Show more items');
+    const toolbarButtonsHidden = !scenesEnabled && (await showMoreItems.count()) > 0;
     if (toolbarButtonsHidden) {
-      await this.ctx.page.getByLabel('Show more items').click();
+      await showMoreItems.click();
     }
 
     if (semver.gte(this.ctx.grafanaVersion, '9.5.0')) {
diff --git a/packages/plugin-e2e/src/models/pages/GrafanaPage.ts b/packages/plugin-e2e/src/models/pages/GrafanaPage.ts
index 7603e2a2..59ea2e0c 100644
--- a/packages/plugin-e2e/src/models/pages/GrafanaPage.ts
+++ b/packages/plugin-e2e/src/models/pages/GrafanaPage.ts
@@ -19,7 +19,7 @@ export abstract class GrafanaPage {
       url += `?${queryParams.toString()}`;
     }
     await this.ctx.page.goto(url, {
-      waitUntil: 'networkidle',
+      waitUntil: 'load',
       ...this.pageArgs,
       ...options,
     });
diff --git a/packages/plugin-e2e/tests/as-admin-user/app/app-config/appConfig.spec.ts b/packages/plugin-e2e/tests/as-admin-user/app/app-config/appConfig.spec.ts
index c8c06927..e176a8b8 100644
--- a/packages/plugin-e2e/tests/as-admin-user/app/app-config/appConfig.spec.ts
+++ b/packages/plugin-e2e/tests/as-admin-user/app/app-config/appConfig.spec.ts
@@ -16,6 +16,6 @@ test('should wait for plugin config settings API to respond', async ({ gotoAppCo
   );
 
   const response = configPage.waitForSettingsResponse();
-  await page.getByRole('button', { name: 'Disable' }).first().click();
+  await page.getByRole('button', { name: /Disable|Enable/i }).first().click();
   await expect(response).toBeOK();
 });
diff --git a/packages/plugin-e2e/tests/as-admin-user/datasource/query-editor/queryEditor.integration.spec.ts b/packages/plugin-e2e/tests/as-admin-user/datasource/query-editor/queryEditor.integration.spec.ts
index 51eb8f92..68316e84 100644
--- a/packages/plugin-e2e/tests/as-admin-user/datasource/query-editor/queryEditor.integration.spec.ts
+++ b/packages/plugin-e2e/tests/as-admin-user/datasource/query-editor/queryEditor.integration.spec.ts
@@ -33,3 +33,5 @@ test('should be possible to load and execute an existing valid query', async ({
   await expect(panelEditPage.refreshPanel()).toBeOK();
   await expect(panelEditPage.panel.getErrorIcon()).not.toBeVisible();
 });
+
+// DEBUG=pw:browser
```